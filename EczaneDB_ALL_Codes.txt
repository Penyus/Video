CREATE DATABASE EczaneDB;
GO
USE EczaneDB;
GO

-- 1. Kategoriler Tablosu
CREATE TABLE Kategoriler (
    KategoriID INT IDENTITY(1,1) PRIMARY KEY,
    KategoriAdi NVARCHAR(50) NOT NULL,
    Aciklama NVARCHAR(200)
);

-- 2. Tedarikçiler Tablosu
CREATE TABLE Tedarikciler (
    TedarikciID INT IDENTITY(1,1) PRIMARY KEY,
    FirmaAdi NVARCHAR(100) NOT NULL,
    YetkiliKisi NVARCHAR(50),
    Telefon NVARCHAR(15),
    Adres NVARCHAR(250)
);

-- 3. İlaçlar Tablosu
CREATE TABLE Ilaclar (
    IlacID INT IDENTITY(1,1) PRIMARY KEY,
    BarkodNo NVARCHAR(50) UNIQUE NOT NULL,
    IlacAdi NVARCHAR(100) NOT NULL,
    KategoriID INT FOREIGN KEY REFERENCES Kategoriler(KategoriID),
    TedarikciID INT FOREIGN KEY REFERENCES Tedarikciler(TedarikciID),
    StokAdedi INT DEFAULT 0,
    BirimFiyat DECIMAL(10,2) NOT NULL,
    SonKullanmaTarihi DATE,
    ReçeteliMi BIT DEFAULT 0 -- 0: Hayır, 1: Evet
);

-- 4. Doktorlar Tablosu
CREATE TABLE Doktorlar (
    DoktorID INT IDENTITY(1,1) PRIMARY KEY,
    Ad NVARCHAR(50) NOT NULL,
    Soyad NVARCHAR(50) NOT NULL,
    Brans NVARCHAR(50),
    DiplomaNo NVARCHAR(20) UNIQUE
);

-- 5. Müşteriler (Hastalar) Tablosu
CREATE TABLE Musteriler (
    MusteriID INT IDENTITY(1,1) PRIMARY KEY,
    TCKimlikNo CHAR(11) UNIQUE NOT NULL,
    Ad NVARCHAR(50) NOT NULL,
    Soyad NVARCHAR(50) NOT NULL,
    Telefon NVARCHAR(15),
    SosyalGuvence NVARCHAR(50) -- SGK, Bağkur vb.
);

-- 6. Reçeteler Tablosu
CREATE TABLE Receteler (
    ReceteID INT IDENTITY(1,1) PRIMARY KEY,
    ReceteNo NVARCHAR(20) UNIQUE NOT NULL,
    MusteriID INT FOREIGN KEY REFERENCES Musteriler(MusteriID),
    DoktorID INT FOREIGN KEY REFERENCES Doktorlar(DoktorID),
    Tarih DATETIME DEFAULT GETDATE()
);

-- 7. Satışlar Tablosu (Fatura Üst Bilgisi)
CREATE TABLE Satislar (
    SatisID INT IDENTITY(1,1) PRIMARY KEY,
    MusteriID INT FOREIGN KEY REFERENCES Musteriler(MusteriID),
    ReceteID INT FOREIGN KEY REFERENCES Receteler(ReceteID), -- Reçetesiz ise NULL olabilir
    SatisTarihi DATETIME DEFAULT GETDATE(),
    ToplamTutar DECIMAL(10,2) DEFAULT 0
);

-- 8. Satış Detayları (Hangi ilaçtan kaç tane satıldı)
CREATE TABLE SatisDetay (
    SatisDetayID INT IDENTITY(1,1) PRIMARY KEY,
    SatisID INT FOREIGN KEY REFERENCES Satislar(SatisID),
    IlacID INT FOREIGN KEY REFERENCES Ilaclar(IlacID),
    Adet INT NOT NULL,
    BirimFiyat DECIMAL(10,2) NOT NULL, -- Satış anındaki fiyat
    AraToplam AS (Adet * BirimFiyat) -- Computed Column
);

-- SP 1: Yeni Kategori Ekleme
CREATE PROCEDURE Sp_KategoriEkle
    @Ad NVARCHAR(50), @Aciklama NVARCHAR(200)
AS
BEGIN
    INSERT INTO Kategoriler (KategoriAdi, Aciklama) VALUES (@Ad, @Aciklama)
END;
GO

-- SP 2: Yeni İlaç Ekleme
CREATE PROCEDURE Sp_IlacEkle
    @Barkod NVARCHAR(50), @Ad NVARCHAR(100), @KatID INT, @TedID INT, @Fiyat DECIMAL(10,2), @SKT DATE
AS
BEGIN
    INSERT INTO Ilaclar (BarkodNo, IlacAdi, KategoriID, TedarikciID, BirimFiyat, SonKullanmaTarihi)
    VALUES (@Barkod, @Ad, @KatID, @TedID, @Fiyat, @SKT)
END;
GO

-- SP 3: Stok Güncelleme (Manuel ekleme için)
CREATE PROCEDURE Sp_StokEkle
    @IlacID INT, @Adet INT
AS
BEGIN
    UPDATE Ilaclar SET StokAdedi = StokAdedi + @Adet WHERE IlacID = @IlacID
END;
GO

-- SP 4: Müşteri Kayıt
CREATE PROCEDURE Sp_MusteriKayit
    @TC CHAR(11), @Ad NVARCHAR(50), @Soyad NVARCHAR(50), @Tel NVARCHAR(15), @SGK NVARCHAR(50)
AS
BEGIN
    IF NOT EXISTS (SELECT * FROM Musteriler WHERE TCKimlikNo = @TC)
    BEGIN
        INSERT INTO Musteriler (TCKimlikNo, Ad, Soyad, Telefon, SosyalGuvence)
        VALUES (@TC, @Ad, @Soyad, @Tel, @SGK)
    END
END;
GO

-- SP 5: Satış Başlatma (Fiş oluşturma)
CREATE PROCEDURE Sp_SatisBaslat
    @MusteriID INT, @ReceteID INT = NULL, @SatisID INT OUTPUT
AS
BEGIN
    INSERT INTO Satislar (MusteriID, ReceteID, SatisTarihi) VALUES (@MusteriID, @ReceteID, GETDATE());
    SET @SatisID = SCOPE_IDENTITY(); -- Oluşan ID'yi geri döndür
END;
GO

-- SP 6: Satışa İlaç Ekleme (Sepete atma)
CREATE PROCEDURE Sp_SatisaIlacEkle
    @SatisID INT, @IlacID INT, @Adet INT
AS
BEGIN
    DECLARE @Fiyat DECIMAL(10,2);
    SELECT @Fiyat = BirimFiyat FROM Ilaclar WHERE IlacID = @IlacID;
    
    INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat)
    VALUES (@SatisID, @IlacID, @Adet, @Fiyat);
END;
GO

-- SP 7: Kritik Stok Raporu (50 adetten az kalanlar)
CREATE PROCEDURE Sp_KritikStokGetir
AS
BEGIN
    SELECT IlacAdi, StokAdedi, BarkodNo FROM Ilaclar WHERE StokAdedi < 50
END;
GO

-- SP 8: Aylık Ciro Raporu
CREATE PROCEDURE Sp_AylikCiro
    @Ay INT, @Yil INT
AS
BEGIN
    SELECT SUM(ToplamTutar) as AylikCiro 
    FROM Satislar 
    WHERE MONTH(SatisTarihi) = @Ay AND YEAR(SatisTarihi) = @Yil
END;
GO

-- SP 9: Reçete Detaylarını Getir
CREATE PROCEDURE Sp_ReceteDetay
    @ReceteNo NVARCHAR(20)
AS
BEGIN
    SELECT R.ReceteNo, M.Ad, M.Soyad, D.Brans, D.Ad AS DoktorAd
    FROM Receteler R
    JOIN Musteriler M ON R.MusteriID = M.MusteriID
    JOIN Doktorlar D ON R.DoktorID = D.DoktorID
    WHERE R.ReceteNo = @ReceteNo
END;
GO

-- SP 10: İlaç Arama (İsme göre)
CREATE PROCEDURE Sp_IlacAra
    @Kelime NVARCHAR(50)
AS
BEGIN
    SELECT * FROM Ilaclar WHERE IlacAdi LIKE '%' + @Kelime + '%'
END;
GO

-- Trigger 1: Satış yapıldığında stoğu otomatik düşür
CREATE TRIGGER Trg_StokDusur
ON SatisDetay
AFTER INSERT
AS
BEGIN
    UPDATE I
    SET I.StokAdedi = I.StokAdedi - inserted.Adet
    FROM Ilaclar I
    JOIN inserted ON I.IlacID = inserted.IlacID
END;
GO

-- Trigger 2: Stok yetersizse satışı engelle
CREATE TRIGGER Trg_StokKontrol
ON SatisDetay
INSTEAD OF INSERT
AS
BEGIN
    DECLARE @Stok INT, @Talep INT, @IlacID INT;
    SELECT @IlacID = IlacID, @Talep = Adet FROM inserted;
    SELECT @Stok = StokAdedi FROM Ilaclar WHERE IlacID = @IlacID;

    IF @Stok >= @Talep
    BEGIN
        INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat)
        SELECT SatisID, IlacID, Adet, BirimFiyat FROM inserted;
    END
    ELSE
    BEGIN
        RAISERROR ('Yetersiz Stok!', 16, 1);
    END
END;
GO

-- Trigger 3: Satış Detay eklendiğinde Ana Tablodaki Toplam Tutarı Güncelle
CREATE TRIGGER Trg_SatisTutarGuncelle
ON SatisDetay
AFTER INSERT
AS
BEGIN
    DECLARE @SatisID INT, @EklenenTutar DECIMAL(10,2);
    SELECT @SatisID = SatisID, @EklenenTutar = (Adet * BirimFiyat) FROM inserted;
    
    UPDATE Satislar SET ToplamTutar = ToplamTutar + @EklenenTutar WHERE SatisID = @SatisID;
END;
GO

-- Trigger 4: İlaç silinmesini engelle (Güvenlik)
CREATE TRIGGER Trg_IlacSilmeEngelle
ON Ilaclar
INSTEAD OF DELETE
AS
BEGIN
    RAISERROR ('Güvenlik nedeniyle ilaç kaydı silinemez. Durumu pasif yapınız.', 16, 1);
END;
GO

-- Trigger 5: İlaç Fiyatı Değiştiğinde Log Tablosuna Yaz (Audit)
-- Önce Log tablosunu oluşturalım
CREATE TABLE FiyatLog (LogID INT IDENTITY(1,1), IlacID INT, EskiFiyat DECIMAL(10,2), YeniFiyat DECIMAL(10,2), Tarih DATETIME);
GO

CREATE TRIGGER Trg_FiyatLog
ON Ilaclar
AFTER UPDATE
AS
BEGIN
    IF UPDATE(BirimFiyat)
    BEGIN
        INSERT INTO FiyatLog (IlacID, EskiFiyat, YeniFiyat, Tarih)
        SELECT d.IlacID, d.BirimFiyat, i.BirimFiyat, GETDATE()
        FROM deleted d
        JOIN inserted i ON d.IlacID = i.IlacID
    END
END;
GO

-- Trigger 6: Müşteri Ad ve Soyadını Büyük Harfe Çevir
CREATE TRIGGER Trg_MusteriBuyukHarf
ON Musteriler
AFTER INSERT, UPDATE
AS
BEGIN
    UPDATE Musteriler
    SET Ad = UPPER(i.Ad), Soyad = UPPER(i.Soyad)
    FROM Musteriler m
    JOIN inserted i ON m.MusteriID = i.MusteriID
END;
GO

-- Trigger 7: Son Kullanma Tarihi Geçmiş İlaç Girişini Engelle
CREATE TRIGGER Trg_SKTKontrol
ON Ilaclar
AFTER INSERT
AS
BEGIN
    IF EXISTS (SELECT * FROM inserted WHERE SonKullanmaTarihi < GETDATE())
    BEGIN
        ROLLBACK TRANSACTION;
        RAISERROR ('Son kullanma tarihi geçmiş ilaç eklenemez!', 16, 1);
    END
END;
GO

-- Trigger 8: Satış İptal Edilirse Stoğu Geri Yükle (Delete Trigger)
CREATE TRIGGER Trg_SatisIptalStokIade
ON SatisDetay
AFTER DELETE
AS
BEGIN
    UPDATE I
    SET I.StokAdedi = I.StokAdedi + d.Adet
    FROM Ilaclar I
    JOIN deleted d ON I.IlacID = d.IlacID
END;
GO

-- Trigger 9: Reçete silinirse bağlı satış kayıtlarını uyar
CREATE TRIGGER Trg_ReceteSilmeKontrol
ON Receteler
INSTEAD OF DELETE
AS
BEGIN
    IF EXISTS (SELECT * FROM Satislar WHERE ReceteID IN (SELECT ReceteID FROM deleted))
    BEGIN
        RAISERROR ('Bu reçeteye bağlı satışlar var, önce satışları iptal edin.', 16, 1);
    END
    ELSE
    BEGIN
        DELETE FROM Receteler WHERE ReceteID IN (SELECT ReceteID FROM deleted);
    END
END;
GO

-- Trigger 10: Tedarikçi Silinirse İlaçların Tedarikçisini NULL Yap (Referans Bütünlüğü)
CREATE TRIGGER Trg_TedarikciSil
ON Tedarikciler
INSTEAD OF DELETE
AS
BEGIN
    UPDATE Ilaclar SET TedarikciID = NULL WHERE TedarikciID IN (SELECT TedarikciID FROM deleted);
    DELETE FROM Tedarikciler WHERE TedarikciID IN (SELECT TedarikciID FROM deleted);
END;
GO

USE EczaneDB;
GO

-- 1. KATEGORİLER (10 Adet)
INSERT INTO Kategoriler (KategoriAdi, Aciklama) VALUES 
('Ağrı Kesici', 'Hafif ve orta şiddetli ağrılar için'),
('Antibiyotik', 'Bakteriyel enfeksiyon tedavisi'),
('Vitamin & Ek Gıda', 'Takviye edici gıdalar'),
('Soğuk Algınlığı', 'Grip ve nezle ilaçları'),
('Mide ve Sindirim', 'Mide koruyucu ve sindirim düzenleyici'),
('Dermatoloji', 'Cilt kremleri ve merhemler'),
('Kalp ve Damar', 'Tansiyon ve kalp ilaçları'),
('Diyabet', 'Şeker hastalığı insülin ve ilaçları'),
('Psikiyatri', 'Antidepresan ve sakinleştiriciler'),
('Kişisel Bakım', 'Şampuan, diş macunu vb.');

-- 2. TEDARİKÇİLER (10 Adet)
INSERT INTO Tedarikciler (FirmaAdi, YetkiliKisi, Telefon, Adres) VALUES 
('Selçuk Ecza Deposu', 'Ahmet Yılmaz', '02125550001', 'İstanbul/Şişli'),
('Hedef Alliance', 'Ayşe Demir', '02165550002', 'İstanbul/Ümraniye'),
('Abdi İbrahim', 'Mehmet Öz', '02125550003', 'İstanbul/Maslak'),
('Bayer Türk', 'Hans Müller', '02165550004', 'İstanbul/Ümraniye'),
('Pfizer İlaç', 'Canan Dağ', '02125550005', 'İstanbul/Ortaköy'),
('Novartis', 'Ali Veli', '02125550006', 'İstanbul/Levent'),
('Bilim İlaç', 'Zeynep Kaya', '02125550007', 'İstanbul/Beyoğlu'),
('Koçak Farma', 'Burak Yıl', '02825550008', 'Tekirdağ/Çerkezköy'),
('Santa Farma', 'Selin Su', '02125550009', 'İstanbul/Esenyurt'),
('Deva Holding', 'Cemil Koç', '02125550010', 'İstanbul/Halkalı');

-- 3. İLAÇLAR (12 Adet - Stoklar 100 civarı ayarlandı)
-- Not: Trigger hatası almamak için SKT'leri ileri tarihli giriyoruz.
INSERT INTO Ilaclar (BarkodNo, IlacAdi, KategoriID, TedarikciID, StokAdedi, BirimFiyat, SonKullanmaTarihi, ReçeteliMi) VALUES 
('869950001', 'Parol 500mg', 1, 3, 150, 85.50, '2026-12-30', 0),
('869950002', 'Arveles 25mg', 1, 1, 80, 110.00, '2027-05-20', 0),
('869950003', 'Augmentin 1000mg', 2, 5, 60, 240.00, '2026-08-15', 1),
('869950004', 'Majezik Sprey', 1, 7, 90, 135.00, '2028-01-01', 0),
('869950005', 'Benexol B12', 3, 4, 200, 150.00, '2026-11-10', 0),
('869950006', 'Tylolhot Poşet', 4, 2, 45, 180.00, '2027-02-14', 0), -- Kritik stok (50 altı)
('869950007', 'Nexium 40mg', 5, 6, 120, 190.50, '2026-09-09', 1),
('869950008', 'Bepanthol Krem', 6, 4, 75, 250.00, '2029-01-01', 0),
('869950009', 'Coraspin 100mg', 7, 4, 300, 75.00, '2027-10-10', 0),
('869950010', 'Lantus İnsülin', 8, 9, 30, 850.00, '2026-07-20', 1), -- Kritik stok
('869950011', 'Prozac 20mg', 9, 1, 55, 320.00, '2026-12-01', 1),
('869950012', 'Sensodyne Diş Macunu', 10, 2, 100, 120.00, '2030-01-01', 0);

-- 4. DOKTORLAR (10 Adet)
INSERT INTO Doktorlar (Ad, Soyad, Brans, DiplomaNo) VALUES 
('Kemal', 'Sunal', 'Dahiliye', 'DIP1001'),
('Haluk', 'Bilginer', 'Kardiyoloji', 'DIP1002'),
('Türkan', 'Şoray', 'Cildiye', 'DIP1003'),
('Şener', 'Şen', 'Kulak Burun Boğaz', 'DIP1004'),
('Adile', 'Naşit', 'Çocuk Sağlığı', 'DIP1005'),
('Cüneyt', 'Arkın', 'Ortopedi', 'DIP1006'),
('Münir', 'Özkul', 'Genel Cerrahi', 'DIP1007'),
('Fatma', 'Girik', 'Nöroloji', 'DIP1008'),
('Tarık', 'Akan', 'Psikiyatri', 'DIP1009'),
('Zeki', 'Alasya', 'Göz Hastalıkları', 'DIP1010');

-- 5. MÜŞTERİLER (10 Adet)
INSERT INTO Musteriler (TCKimlikNo, Ad, Soyad, Telefon, SosyalGuvence) VALUES 
('11111111110', 'Ahmet', 'Yılmaz', '5321001010', 'SGK'),
('22222222220', 'Ayşe', 'Kaya', '5321002020', 'Bağkur'),
('33333333330', 'Mehmet', 'Demir', '5321003030', 'Emekli Sandığı'),
('44444444440', 'Fatma', 'Çelik', '5321004040', 'Özel Sigorta'),
('55555555550', 'Mustafa', 'Şahin', '5321005050', 'SGK'),
('66666666660', 'Elif', 'Yıldız', '5321006060', 'Yok'),
('77777777770', 'Burak', 'Arslan', '5321007070', 'SGK'),
('88888888880', 'Selin', 'Polat', '5321008080', 'Özel Sigorta'),
('99999999990', 'Cem', 'Öztürk', '5321009090', 'Bağkur'),
('10101010100', 'Deniz', 'Erkin', '5321010101', 'SGK');

-- 6. REÇETELER (10 Adet)
INSERT INTO Receteler (ReceteNo, MusteriID, DoktorID, Tarih) VALUES 
('REC001', 1, 1, '2025-12-01'),
('REC002', 2, 3, '2025-12-02'),
('REC003', 3, 2, '2025-12-03'),
('REC004', 5, 5, '2025-12-05'),
('REC005', 7, 4, '2025-12-06'),
('REC006', 9, 8, '2025-12-07'),
('REC007', 1, 9, '2025-12-08'),
('REC008', 4, 2, '2025-12-09'),
('REC009', 10, 6, '2025-12-10'),
('REC010', 8, 7, '2025-12-11');

-- 7. SATIŞLAR (10 Adet - Fatura Başlıkları)
-- Not: ToplamTutar trigger ile güncellenecek ama başlangıçta 0 giriyoruz.
INSERT INTO Satislar (MusteriID, ReceteID, SatisTarihi, ToplamTutar) VALUES 
(1, 1, '2025-12-01 10:30', 0),
(2, NULL, '2025-12-01 11:00', 0), -- Reçetesiz satış
(3, 3, '2025-12-02 09:15', 0),
(4, NULL, '2025-12-03 14:20', 0),
(5, 4, '2025-12-04 16:45', 0),
(6, NULL, '2025-12-05 12:00', 0),
(7, 5, '2025-12-06 13:30', 0),
(8, NULL, '2025-12-07 10:00', 0),
(9, 6, '2025-12-08 11:45', 0),
(10, NULL, '2025-12-09 15:30', 0);

-- 8. SATIŞ DETAYLARI (Triggerlar burada devreye girecek)
-- Bu işlem sırasında Trg_StokDusur çalışacak ve stoklar güncellenecek.
-- Ayrıca Trg_SatisTutarGuncelle çalışacak ve Satislar tablosundaki tutarlar artacak.

-- Satış 1 için detay (Parol satıldı)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (1, 1, 2, 85.50);
-- Satış 2 için detay (Arveles satıldı)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (2, 2, 1, 110.00);
-- Satış 3 için detay (Coraspin satıldı)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (3, 9, 1, 75.00);
-- Satış 4 için detay (Majezik)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (4, 4, 1, 135.00);
-- Satış 5 için detay (Tylolhot - Stok 45'e düşecek)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (5, 6, 2, 180.00);
-- Satış 6 için detay (Benexol)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (6, 5, 1, 150.00);
-- Satış 7 için detay (Augmentin)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (7, 3, 1, 240.00);
-- Satış 8 için detay (Sensodyne)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (8, 12, 3, 120.00);
-- Satış 9 için detay (Lantus)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (9, 10, 2, 850.00);
-- Satış 10 için detay (Bepanthol)
INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat) VALUES (10, 8, 1, 250.00);

USE EczaneDB;
GO

-- ADIM 1: STOKLARI GÜÇLENDİR (Hata almamak için)
-- Toplu satış verisi gireceğimiz için stokları geçici olarak artırıyoruz.
UPDATE Ilaclar SET StokAdedi = 5000;
PRINT 'Stoklar toplu veri girişi için artırıldı.';

-- ADIM 2: RASTGELE 100 MÜŞTERİ OLUŞTURMA
DECLARE @i INT = 1;
DECLARE @Adlar TABLE (Ad NVARCHAR(20));
DECLARE @Soyadlar TABLE (Soyad NVARCHAR(20));

-- Havuz verisi
INSERT INTO @Adlar VALUES ('Ahmet'), ('Mehmet'), ('Ayşe'), ('Fatma'), ('Can'), ('Cem'), ('Zeynep'), ('Elif'), ('Burak'), ('Selin'), ('Deniz'), ('Emre'), ('Gamze'), ('Hakan'), ('İpek'), ('Kaan'), ('Lale'), ('Mert'), ('Nur'), ('Ozan');
INSERT INTO @Soyadlar VALUES ('Yılmaz'), ('Kaya'), ('Demir'), ('Çelik'), ('Şahin'), ('Yıldız'), ('Arslan'), ('Polat'), ('Öztürk'), ('Erkin'), ('Koç'), ('Aydın'), ('Özkan'), ('Tekin'), ('Yavuz'), ('Aslan'), ('Ünal'), ('Kılıç'), ('Toprak'), ('Sönmez');

WHILE @i <= 100
BEGIN
    DECLARE @RndAd NVARCHAR(20) = (SELECT TOP 1 Ad FROM @Adlar ORDER BY NEWID());
    DECLARE @RndSoyad NVARCHAR(20) = (SELECT TOP 1 Soyad FROM @Soyadlar ORDER BY NEWID());
    DECLARE @RndTC CHAR(11) = CAST(CAST(10000000000 + (ABS(CHECKSUM(NEWID())) % 89999999999) AS BIGINT) AS CHAR(11));
    DECLARE @RndTel NVARCHAR(15) = '5' + CAST(CAST(300000000 + (ABS(CHECKSUM(NEWID())) % 99999999) AS INT) AS NVARCHAR(15));
    
    -- TC Çakışmasını önlemek için Try-Catch
    BEGIN TRY
        INSERT INTO Musteriler (TCKimlikNo, Ad, Soyad, Telefon, SosyalGuvence)
        VALUES (@RndTC, @RndAd, @RndSoyad, @RndTel, 'SGK');
    END TRY
    BEGIN CATCH
        -- TC çakışırsa pas geç
    END CATCH
    
    SET @i = @i + 1;
END
PRINT '100 adet rastgele müşteri eklendi.';

-- ADIM 3: RASTGELE 50 REÇETE OLUŞTURMA
SET @i = 1;
DECLARE @MaxMusteri INT = (SELECT MAX(MusteriID) FROM Musteriler);
DECLARE @MaxDoktor INT = (SELECT MAX(DoktorID) FROM Doktorlar);

WHILE @i <= 50
BEGIN
    DECLARE @RndMusteri INT = (ABS(CHECKSUM(NEWID())) % @MaxMusteri) + 1;
    DECLARE @RndDoktor INT = (ABS(CHECKSUM(NEWID())) % @MaxDoktor) + 1;
    DECLARE @RndTarih DATETIME = DATEADD(DAY, -(ABS(CHECKSUM(NEWID())) % 365), GETDATE()); -- Son 1 yıl
    DECLARE @ReceteNo NVARCHAR(20) = 'REC-AUTO-' + CAST(@i AS NVARCHAR);

    IF EXISTS (SELECT 1 FROM Musteriler WHERE MusteriID = @RndMusteri)
    BEGIN
        INSERT INTO Receteler (ReceteNo, MusteriID, DoktorID, Tarih)
        VALUES (@ReceteNo, @RndMusteri, @RndDoktor, @RndTarih);
    END

    SET @i = @i + 1;
END
PRINT '50 adet rastgele reçete eklendi.';

-- ADIM 4: RASTGELE 500 SATIŞ VE DETAYLARI (EN ÖNEMLİ KISIM)
SET @i = 1;
DECLARE @MaxIlac INT = (SELECT MAX(IlacID) FROM Ilaclar);

WHILE @i <= 500
BEGIN
    -- 1. Rastgele Satış Başlığı Oluştur
    DECLARE @SatisMusteri INT = (ABS(CHECKSUM(NEWID())) % @MaxMusteri) + 1;
    DECLARE @SatisTarih DATETIME = DATEADD(DAY, -(ABS(CHECKSUM(NEWID())) % 365), GETDATE()); -- Son 1 yıl içinde
    
    IF EXISTS (SELECT 1 FROM Musteriler WHERE MusteriID = @SatisMusteri)
    BEGIN
        INSERT INTO Satislar (MusteriID, SatisTarihi, ToplamTutar)
        VALUES (@SatisMusteri, @SatisTarih, 0); -- Tutar trigger ile dolacak

        DECLARE @YeniSatisID INT = SCOPE_IDENTITY();

        -- 2. Bu satışa 1 ile 4 arasında rastgele ilaç ekle
        DECLARE @KalemSayisi INT = (ABS(CHECKSUM(NEWID())) % 4) + 1;
        DECLARE @k INT = 1;

        WHILE @k <= @KalemSayisi
        BEGIN
            DECLARE @RndIlac INT = (ABS(CHECKSUM(NEWID())) % @MaxIlac) + 1;
            DECLARE @RndAdet INT = (ABS(CHECKSUM(NEWID())) % 3) + 1; -- 1-3 adet arası
            DECLARE @Fiyat DECIMAL(10,2);
            
            SELECT @Fiyat = BirimFiyat FROM Ilaclar WHERE IlacID = @RndIlac;

            IF @Fiyat IS NOT NULL
            BEGIN
                -- SatisDetay'a ekle (Trigger'lar burada çalışıp stoğu düşecek ve tutarı güncelleyecek)
                INSERT INTO SatisDetay (SatisID, IlacID, Adet, BirimFiyat)
                VALUES (@YeniSatisID, @RndIlac, @RndAdet, @Fiyat);
            END

            SET @k = @k + 1;
        END
    END

    SET @i = @i + 1;
END
PRINT '500 adet satış ve detayları eklendi.';
GO